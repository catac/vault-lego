env:
  global:
  - AUTHOR_EMAIL=catalin.cirstoiu@gmail.com
  - REGISTRY_USERNAME=catac
  - REGISTRY=index.docker.io
services:
- docker
language: go
go:
- 1.10.1
install:
- go get github.com/Masterminds/glide
script:
- make test
- if ([[ ${TRAVIS_BRANCH} == "master" ]] && [[ ${TRAVIS_PULL_REQUEST} != "true" ]])
  || [[ -n ${TRAVIS_TAG} ]]; then docker login -u ${REGISTRY_USERNAME} -p ${REGISTRY_TOKEN}
  -e ${AUTHOR_EMAIL} ${REGISTRY}; VERSION="latest" make docker-release; fi
before_deploy:
- NAME=GOOS=linux GOARCH=amd64 go build -o bin/vault-lego-linux-amd64
after_deploy:
- docker login -u ${REGISTRY_USERNAME} -p ${REGISTRY_TOKEN} -e ${AUTHOR_EMAIL} ${REGISTRY}
- VERSION=$TRAVIS_TAG make docker-release
deploy:
  provider: releases
  skip_cleanup: true
  on:
    repo: catac/vault-lego
    tags: true
  api_key:
    secure: ${GITHUB_TOKEN}
  file: bin/vault-lego-linux-amd64
